<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics AI | Hub Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-active { border-bottom: 4px solid #4f46e5; color: #4f46e5; }
        #reader { border-radius: 1.5rem; overflow: hidden; border: none!important; }
        #reader__dashboard_section_csr button { background: #4f46e5!important; color: white!important; border-radius: 0.5rem!important; padding: 0.5rem 1rem!important; font-weight: bold!important; }
    </style>
</head>
<body class="min-h-screen">

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold italic shadow-lg shadow-indigo-200">L</div>
                <span class="font-extrabold text-xl tracking-tight text-slate-800 uppercase">Logistics AI Hub</span>
            </div>
            <div class="flex gap-8 h-full">
                <button onclick="toggle('gen')" id="b-gen" class="tab-active font-bold px-2 flex items-center h-full transition-all">1. GENERATE LABEL</button>
                <button onclick="toggle('scan')" id="b-scan" class="font-bold px-2 flex items-center h-full text-slate-400 transition-all">2. SCAN & INVOICE</button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        
        <!-- Generator Section -->
        <section id="s-gen" class="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in duration-500">
            <div class="lg:col-span-7 bg-white p-8 rounded-[2rem] shadow-xl shadow-indigo-500/5 border border-slate-100">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Dispatch Entry Form</h2>
                <form id="qrForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Customer Name</label>
                            <input type="text" id="cust" placeholder="e.g. Rushikesh Kokate" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Seller Name</label>
                            <input type="text" id="sell" placeholder="e.g. Shreyash Retail Pvt Ltd" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Delivery Address</label>
                        <textarea id="addr" rows="2" required placeholder="Full street, city, landmark..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all resize-none"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Sorting Hub (Zone)</label>
                            <select id="hub" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-indigo-600 appearance-none">
                                <option value="Baramati">Baramati Hub</option>
                                <option value="Pune">Pune Hub</option>
                                <option value="Indapur">Indapur Hub</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Price (₹)</label>
                            <input type="number" id="price" placeholder="0.00" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Weight (kg)</label>
                            <input type="number" step="0.1" id="wt" placeholder="0.5" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Product Category</label>
                            <select id="type" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                                <option value="Electronics & Appliances">Electronics & Appliances</option>
                                <option value="Fashion">Fashion</option>
                                <option value="Home & Furniture">Home & Furniture</option>
                                <option value="Grocery & Essentials">Grocery & Essentials</option>
                                <option value="Beauty & Personal Care">Beauty & Personal Care</option>
                                <option value="Books & Stationery">Books & Stationery</option>
                                <option value="Sports, Toys & Baby Products">Sports, Toys & Baby Products</option>
                                <option value="Musical Instruments">Musical Instruments</option>
                                <option value="Pharmaceutical">Pharmaceutical</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Payment Method</label>
                        <select id="pay" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                            <option value="Prepaid">Prepaid</option>
                            <option value="Cash on Delivery">Cash on Delivery (COD)</option>
                            <option value="Online">UPI / Online</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-extrabold py-5 rounded-2xl shadow-xl shadow-indigo-100 hover:bg-indigo-700 active:scale-[0.98] transition-all mt-4 uppercase">
                        Generate Logistic Label
                    </button>
                </form>
            </div>

            <div id="qr-result" class="lg:col-span-5 flex flex-col items-center justify-center space-y-6">
                <div id="preview-card" class="hidden bg-white p-10 rounded-[3rem] shadow-2xl border border-slate-100 flex flex-col items-center animate-in zoom-in duration-300">
                    <div id="qrcode" class="p-4 bg-white rounded-3xl border-4 border-slate-900 shadow-inner mb-4"></div>
                    <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest text-center">Industrial Scan Ready</p>
                    <button onclick="dlQR()" class="mt-6 w-full flex items-center justify-center gap-2 bg-slate-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-black transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download Label
                    </button>
                </div>
                <div id="placeholder" class="w-full aspect-square rounded-[3rem] border-4 border-dashed border-slate-300 flex items-center justify-center text-slate-400 font-bold opacity-50 text-center px-8">
                    Fill the form to generate a <br>machine-readable barcode label
                </div>
            </div>
        </section>

        <!-- Scanner Section -->
        <section id="s-scan" class="hidden max-w-2xl mx-auto space-y-8 animate-in slide-in-from-bottom-8 duration-500">
            <div class="bg-white p-8 rounded-[2rem] shadow-lg border border-slate-100 text-center">
                <h2 class="text-xl font-bold mb-4 text-slate-800 uppercase tracking-tight">AI Vision Scanner</h2>
                <div id="reader" class="bg-slate-50 border-2 border-dashed border-slate-200 shadow-inner"></div>
                <p class="mt-6 text-xs text-slate-400 font-bold uppercase tracking-widest">Automatic Tax Invoice Generation</p>
            </div>
            
            <div id="log" class="hidden bg-emerald-500 p-6 rounded-3xl text-white text-center font-bold text-lg shadow-xl shadow-emerald-100 animate-bounce">
                ✅ PARCEL IDENTIFIED: GENERATING INVOICE...
            </div>
        </section>

    </main>

    <script>
        let scanner;

        // Corrected Toggle Function
        function toggle(tab) {
            const isGen = tab === 'gen';
            document.getElementById('s-gen').classList.toggle('hidden', !isGen);
            document.getElementById('s-scan').classList.toggle('hidden', isGen);
            
            // UI Feedback for tabs
            document.getElementById('b-gen').className = isGen 
                ? 'tab-active font-bold px-2 flex items-center h-full' 
                : 'font-bold px-2 flex items-center h-full text-slate-400';
            
            document.getElementById('b-scan').className = !isGen 
                ? 'tab-active font-bold px-2 flex items-center h-full' 
                : 'font-bold px-2 flex items-center h-full text-slate-400';

            if (!isGen) {
                startCam();
            } else {
                stopCam();
            }
        }

        const form = document.getElementById('qrForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = "";
            
            // Data Structure: Cust|Sell|Addr|Hub|Category|Weight|PayMethod|Price
            const fields = [
                document.getElementById('cust').value,
                document.getElementById('sell').value,
                document.getElementById('addr').value.replace(/\|/g, ' '), // Remove pipes from address
                document.getElementById('hub').value,
                document.getElementById('type').value,
                document.getElementById('wt').value,
                document.getElementById('pay').value,
                document.getElementById('price').value
            ];
            const dataStr = fields.join('|');

            new QRCode(qrDiv, { 
                text: dataStr, 
                width: 220, 
                height: 220, 
                correctLevel: QRCode.CorrectLevel.H 
            });
            
            document.getElementById('preview-card').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden');
        });

        function dlQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) return;
            const link = document.createElement('a');
            link.download = `Parcel_Label_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        function startCam() {
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (txt) => {
                if (navigator.vibrate) navigator.vibrate(100);
                document.getElementById('log').classList.remove('hidden');
                makeInvoice(txt);
                setTimeout(() => document.getElementById('log').classList.add('hidden'), 3000);
            }).catch(e => console.warn("Camera Init Error:", e));
        }

        function stopCam() { 
            if (scanner && scanner.isScanning) {
                scanner.stop().then(() => scanner.clear()).catch(e => console.warn(e));
            }
        }

        function makeInvoice(raw) {
            const f = raw.split('|');
            if (f.length < 8) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const margin = 15;
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text("Tax Invoice", margin, 25);
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100);
            doc.text(`Invoice Number: INV-${Date.now()}`, margin, 35);
            doc.text(`Order Number: ORD-${Math.floor(Math.random()*1000000000)}`, margin, 40);
            doc.text(`Place of Supply: MAHARASHTRA`, margin, 45);

            doc.setTextColor(0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text("Bill to / Ship to:", margin, 60);
            doc.text("Bill From:", 110, 60);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(f[0], margin, 66); // Customer
            const addrLines = doc.splitTextToSize(f[2], 80);
            doc.text(addrLines, margin, 71); // Address

            doc.text(f[1], 110, 66); // Seller
            doc.text("Ksquare Industrial Park, Unit-4,", 110, 71);
            doc.text("Nashik-Mumbai Highway, THANE-421101", 110, 76);

            const price = parseFloat(f[7]) || 0;
            const taxableAmt = (price / 1.18).toFixed(2);
            const igst = (price - taxableAmt).toFixed(2);

            doc.autoTable({
                startY: 95,
                head: [['Description', 'Qty', 'Unit Price', 'Taxable Amt', 'IGST (18%)', 'Total']],
                body: [[
                    `${f[4]} \nCategory: ${f[4]} \nWeight: ${f[5]}kg`,
                    '1',
                    `Rs ${taxableAmt}`,
                    `Rs ${taxableAmt}`,
                    `Rs ${igst}`,
                    `Rs ${price.toFixed(2)}`
                ]],
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229], textColor: [255, 255, 255] },
                styles: { fontSize: 8 }
            });

            const finalY = doc.lastAutoTable.finalY;
            doc.setFont('helvetica', 'bold');
            doc.text(`TOTAL AMOUNT: Rs ${price.toFixed(2)}`, 195, finalY + 15, { align: 'right' });

            // Industrial Footer logic for PLC routing
            doc.setFillColor(245, 247, 250);
            doc.rect(margin, finalY + 30, 180, 25, 'F');
            doc.setFontSize(8);
            doc.setTextColor(79, 70, 229);
            doc.text("INDUSTRIAL ROUTING TELEMETRY (PLC PACKET DATA)", margin + 5, finalY + 40);
            doc.setTextColor(0);
            doc.text(`DESTINATION HUB: ${f[3].toUpperCase()}`, margin + 5, finalY + 47);
            
            // Simulated PLC response based on scanned zone
            let action = "DIRECT FLOW";
            if (f[3] === 'Baramati') action = "PNEUMATIC ACTUATOR 1";
            else if (f[3] === 'Indapur') action = "PNEUMATIC ACTUATOR 2";
            
            doc.text(`PLC MECHANICAL ACTION: ${action}`, margin + 90, finalY + 47);

            doc.save(`Invoice_${f[0].replace(/\s+/g, '_')}.pdf`);
        }
    </script>
</body>
</html>
